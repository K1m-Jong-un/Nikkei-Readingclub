<!DOCTYPE html>
<html lang="ja" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Archive | 日本経済新聞を読む会</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind設定 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        nikkei: {
                            main: '#004F8A',
                            dark: '#003366',
                            light: '#E6EEF5',
                            accent: '#C41230',
                            bg: '#F8FAFC',
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', 'sans-serif'],
                        serif: ['"Noto Serif JP"', 'serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            color: #333;
            line-height: 1.8;
            background-color: #F8FAFC;
        }
        h1, h2, h3, .serif-font {
            font-family: 'Noto Serif JP', serif;
        }
        
        /* フェードインアニメーション */
        .fade-in-up {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .fade-in-up.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* ニュースリストのホバーエフェクト */
        .news-item {
            transition: all 0.3s ease;
        }
        .news-item:hover {
            background-color: #f8fafc;
            transform: translateX(5px);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- ヘッダー -->
    <header class="fixed w-full z-50 bg-white/95 backdrop-blur-sm shadow-sm border-b border-gray-100">
        <div class="container mx-auto px-6 h-16 md:h-20 flex justify-between items-center">
            <a href="https://k1m-jong-un.github.io/Nikkei-Readingclub" class="text-xl md:text-2xl font-bold text-nikkei-main tracking-tight serif-font flex items-center gap-3 hover:opacity-80 transition">
                <div class="bg-nikkei-main text-white p-1.5 rounded">
                    <i data-lucide="newspaper" class="w-5 h-5 md:w-6 md:h-6"></i>
                </div>
                <span>日本経済新聞を読む会</span>
            </a>
            
            <nav class="hidden md:flex space-x-8 font-medium text-gray-600 text-sm tracking-wide">
                <a href="https://k1m-jong-un.github.io/Nikkei-Readingclub" class="hover:text-nikkei-main hover:bg-nikkei-light px-3 py-2 rounded-md transition duration-300 flex items-center gap-2">
                    <i data-lucide="home" class="w-4 h-4"></i>
                    ホーム
                </a>
            </nav>

            <button class="md:hidden text-gray-600">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </div>
    </header>

    <main class="flex-grow pt-24 pb-20">
        <!-- ページタイトルエリア -->
        <div class="bg-nikkei-main text-white py-12 md:py-16 mb-12">
            <div class="container mx-auto px-6 text-center">
                <h1 class="text-3xl md:text-4xl font-bold mb-4">News Archive</h1>
                <p class="text-nikkei-light text-sm md:text-base opacity-90">活動のお知らせ・過去のニュース一覧</p>
            </div>
        </div>

        <div class="container mx-auto px-6 max-w-6xl">
            <div class="flex flex-col lg:flex-row gap-12">
                
                <!-- メインコンテンツ -->
                <div class="lg:w-3/4">
                    <!-- カテゴリフィルタ（タブ） -->
                    <div id="category-tabs" class="flex gap-4 border-b border-gray-200 mb-8 pb-1 overflow-x-auto">
                        <button data-category="すべて" class="px-4 py-2 font-bold text-sm whitespace-nowrap border-b-2 border-nikkei-main text-nikkei-main transition">すべて</button>
                        <button data-category="お知らせ" class="px-4 py-2 font-medium text-sm whitespace-nowrap text-gray-500 hover:text-nikkei-main border-b-2 border-transparent transition">お知らせ</button>
                        <button data-category="活動報告" class="px-4 py-2 font-medium text-sm whitespace-nowrap text-gray-500 hover:text-nikkei-main border-b-2 border-transparent transition">活動報告</button>
                        <button data-category="イベント" class="px-4 py-2 font-medium text-sm whitespace-nowrap text-gray-500 hover:text-nikkei-main border-b-2 border-transparent transition">イベント</button>
                    </div>
                    
                    <!-- フィルタ状態の表示（複合条件対応） -->
                    <div id="filter-status" class="hidden mb-6 bg-blue-50/50 p-4 rounded-lg border border-blue-100">
                        <div class="flex flex-wrap items-center gap-3">
                            <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Active Filters:</span>
                            <div id="active-filters-list" class="flex flex-wrap gap-2">
                                <!-- JSでバッジが挿入されます -->
                            </div>
                            <button onclick="resetFilters()" class="ml-auto text-xs text-red-600 hover:text-red-800 hover:underline flex items-center gap-1 font-medium px-2 py-1 rounded hover:bg-red-50 transition">
                                <i data-lucide="trash-2" class="w-3 h-3"></i> 全て解除
                            </button>
                        </div>
                    </div>

                    <!-- ニュースリストコンテナ -->
                    <div id="news-container" class="space-y-0 divide-y divide-gray-100 border-t border-b border-gray-100 min-h-[300px]">
                        <!-- JS Loading... -->
                    </div>

                    <!-- ページネーション -->
                    <div id="pagination-container" class="mt-12 flex justify-center gap-2">
                        <!-- JSでここにボタンが挿入されます -->
                    </div>
                </div>

                <!-- サイドバー -->
                <aside class="lg:w-1/4 space-y-8">
                    <!-- 検索ボックス -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-sm">
                            <i data-lucide="search" class="w-4 h-4 text-nikkei-main"></i> 記事検索
                        </h3>
                        <div class="relative">
                            <!-- IDを追加: search-input -->
                            <input type="text" id="search-input" placeholder="キーワードを入力..." class="w-full bg-gray-50 border border-gray-200 rounded-lg py-2 px-4 text-sm focus:outline-none focus:border-nikkei-main transition">
                            <!-- IDを追加: search-button -->
                            <button id="search-button" class="absolute right-3 top-2.5 text-gray-400 hover:text-nikkei-main transition">
                                <i data-lucide="search" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 年別アーカイブ -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-sm">
                            <i data-lucide="calendar" class="w-4 h-4 text-nikkei-main"></i> Archive
                        </h3>
                        <ul class="space-y-3 text-sm text-gray-600">
                            <li>
                                <button onclick="filterByYear('2026')" class="w-full flex justify-between hover:text-nikkei-main transition group text-left year-btn" data-year-btn="2026">
                                    <span class="group-hover:translate-x-1 transition-transform">2026年</span> 
                                    <span class="bg-gray-100 px-2 py-0.5 rounded-full text-xs text-gray-500 archive-count" data-year="2026">0</span>
                                </button>
                            </li>
                            <li>
                                <button onclick="filterByYear('2025')" class="w-full flex justify-between hover:text-nikkei-main transition group text-left year-btn" data-year-btn="2025">
                                    <span class="group-hover:translate-x-1 transition-transform">2025年</span> 
                                    <span class="bg-gray-100 px-2 py-0.5 rounded-full text-xs text-gray-500 archive-count" data-year="2025">0</span>
                                </button>
                            </li>
                            <li>
                                <button onclick="filterByYear('2024')" class="w-full flex justify-between hover:text-nikkei-main transition group text-left year-btn" data-year-btn="2024">
                                    <span class="group-hover:translate-x-1 transition-transform">2024年</span> 
                                    <span class="bg-gray-100 px-2 py-0.5 rounded-full text-xs text-gray-500 archive-count" data-year="2024">0</span>
                                </button>
                            </li>
                        </ul>
                    </div>

                    <!-- 人気のタグ -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-sm">
                            <i data-lucide="tag" class="w-4 h-4 text-nikkei-main"></i> Tags
                        </h3>
                        <div class="flex flex-wrap gap-2" id="tags-container">
                            <button onclick="filterByTag('お知らせ')" class="text-xs bg-gray-100 hover:bg-nikkei-light hover:text-nikkei-main px-3 py-1.5 rounded-full transition tag-btn" data-tag="お知らせ">#お知らせ</button>
                            <button onclick="filterByTag('活動報告')" class="text-xs bg-gray-100 hover:bg-nikkei-light hover:text-nikkei-main px-3 py-1.5 rounded-full transition tag-btn" data-tag="活動報告">#活動報告</button>
                            <button onclick="filterByTag('イベント')" class="text-xs bg-gray-100 hover:bg-nikkei-light hover:text-nikkei-main px-3 py-1.5 rounded-full transition tag-btn" data-tag="イベント">#イベント</button>
                            <button onclick="filterByTag('企業訪問')" class="text-xs bg-gray-100 hover:bg-nikkei-light hover:text-nikkei-main px-3 py-1.5 rounded-full transition tag-btn" data-tag="企業訪問">#企業訪問</button>
                            <button onclick="filterByTag('通常活動')" class="text-xs bg-gray-100 hover:bg-nikkei-light hover:text-nikkei-main px-3 py-1.5 rounded-full transition tag-btn" data-tag="通常活動">#通常活動</button>
                        </div>
                    </div>
                </aside>

            </div>
        </div>
    </main>

    <!-- JavaScript: データとロジック -->
    <script>
        // ---------------------------------------------------------
        // ニュースデータ
        // ---------------------------------------------------------
        const newsData = [
            { 
                date: '2026.01.05', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2025.12.15', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2025.12.01', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2025.11.17', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2025.11.03', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2025.10.20', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2025.10.14', category: '活動報告', title: '活動報告書を図書館に設置していただきました', url: '#',
                tags: ['活動報告']
            },
            { 
                date: '2025.10.14', category: '活動報告', title: '活動報告書を発行しました', url: '#',
                tags: ['活動報告']
            },
            { 
                date: '2025.10.14', category: 'お知らせ', title: '活動報告書を発行しました', url: '#',
                tags: ['お知らせ']
            },
            { 
                date: '2025.10.06', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2025.09.22', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2025.09.21', category: 'イベント', title: '悠久祭に出店しました', url: '#',
                tags: ['イベント']
            },
            { 
                date: '2025.09.20', category: 'イベント', title: '悠久祭に出店しました', url: '#',
                tags: ['イベント']
            },
            { 
                date: '2025.07.21', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2025.07.07', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2025.06.23', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2025.06.09', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2025.05.12', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2025.04.28', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2025.04.14', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2024.12.16', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2024.12.02', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2024.11.18', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2024.11.06', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2024.10.21', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2024.10.07', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2024.09.24', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2024.07.22', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2024.07.08', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2024.06.25', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2024.06.10', category: 'お知らせ', title: '次回の活動は１号館 ３階 LC3にて16:10より行います', url: '#',
                tags: ['お知らせ', '通常活動']
            },
            { 
                date: '2024.05.26', category: 'お知らせ', title: '日本経済新聞を読む会が始動しました', url: '#',
                tags: ['お知らせ', '通常活動']
            }
        ];

        // 設定
        const ITEMS_PER_PAGE = 5;
        let currentPage = 1;
        
        // フィルタ状態 (独立して管理)
        let currentCategory = 'すべて'; 
        let currentYear = null;         
        let currentTag = null; 
        let currentSearchQuery = ''; // 新規追加: 検索キーワード

        // カテゴリごとの色設定
        const categoryColors = {
            'お知らせ': 'bg-blue-100 text-blue-700',
            '活動報告': 'bg-nikkei-light text-nikkei-main',
            'イベント': 'bg-orange-100 text-orange-700',
            'メディア': 'bg-purple-100 text-purple-700',
            'default': 'bg-gray-100 text-gray-600'
        };

        const newsContainer = document.getElementById('news-container');
        const paginationContainer = document.getElementById('pagination-container');
        const tabButtons = document.querySelectorAll('#category-tabs button');
        const filterStatus = document.getElementById('filter-status');
        const activeFiltersList = document.getElementById('active-filters-list');
        const tagButtons = document.querySelectorAll('.tag-btn');
        const yearButtons = document.querySelectorAll('.year-btn');
        
        // 検索要素の取得
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');

        // ---------------------------------------------------------
        // Archive件数の自動計算
        // ---------------------------------------------------------
        function updateArchiveCounts() {
            document.querySelectorAll('.archive-count').forEach(span => {
                const year = span.getAttribute('data-year');
                const count = newsData.filter(item => item.date.startsWith(year)).length;
                span.textContent = count;
            });
        }

        // ---------------------------------------------------------
        // 検索機能 (新規追加)
        // ---------------------------------------------------------
        
        // 検索実行関数
        function performSearch() {
            const query = searchInput.value.trim();
            // 空白で検索した場合は検索解除と同じ扱いにするか、そのまま絞り込むか
            // ここでは検索ワードをセットしてUI更新
            currentSearchQuery = query;
            updateUI();
        }

        // ボタンクリックで検索
        searchButton.addEventListener('click', performSearch);

        // Enterキーで検索
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // 検索解除
        function clearSearch() {
            currentSearchQuery = '';
            searchInput.value = ''; // 入力欄もクリア
            updateUI();
        }

        // ---------------------------------------------------------
        // 各種フィルタ更新処理（複合条件対応）
        // ---------------------------------------------------------

        // 1. カテゴリ切り替え
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                currentCategory = btn.getAttribute('data-category');
                // 他のフィルタ(currentYear, currentTag)はリセットしない
                updateUI();
            });
        });

        // 2. 年フィルタリング
        function filterByYear(year) {
            // 同じ年をクリックしたら解除（トグル）
            if (currentYear === year) {
                currentYear = null;
            } else {
                currentYear = year;
            }
            updateUI();
        }

        // 3. タグフィルタリング
        function filterByTag(tag) {
            // 同じタグをクリックしたら解除（トグル）
            if (currentTag === tag) {
                currentTag = null;
            } else {
                currentTag = tag;
            }
            updateUI();
        }

        // 4. 個別のフィルタ解除
        function clearCategory() {
            currentCategory = 'すべて';
            updateUI();
        }
        
        function clearYear() {
            currentYear = null;
            updateUI();
        }

        function clearTag() {
            currentTag = null;
            updateUI();
        }

        // 5. 全解除
        function resetFilters() {
            currentYear = null;
            currentTag = null;
            currentCategory = 'すべて';
            currentSearchQuery = ''; // 検索もリセット
            searchInput.value = '';
            updateUI();
        }

        // ---------------------------------------------------------
        // UI更新（統合関数）
        // ---------------------------------------------------------
        function updateUI() {
            updateTabStyles();
            updateYearStyles();
            updateTagStyles();
            updateFilterStatus();
            renderPage(1); // ページを1に戻して再描画
        }

        function updateTabStyles() {
            tabButtons.forEach(btn => {
                const category = btn.getAttribute('data-category');
                if (category === currentCategory) {
                    btn.className = 'px-4 py-2 font-bold text-sm whitespace-nowrap border-b-2 border-nikkei-main text-nikkei-main transition';
                } else {
                    btn.className = 'px-4 py-2 font-medium text-sm whitespace-nowrap text-gray-500 hover:text-nikkei-main border-b-2 border-transparent transition';
                }
            });
        }

        function updateYearStyles() {
            yearButtons.forEach(btn => {
                const year = btn.getAttribute('data-year-btn');
                const countSpan = btn.querySelector('.archive-count');
                
                if (year === currentYear) {
                    // 選択中スタイル
                    btn.classList.add('font-bold', 'text-nikkei-main');
                    countSpan.className = 'bg-nikkei-main text-white px-2 py-0.5 rounded-full text-xs archive-count shadow-sm';
                } else {
                    // 通常スタイル
                    btn.classList.remove('font-bold', 'text-nikkei-main');
                    countSpan.className = 'bg-gray-100 px-2 py-0.5 rounded-full text-xs text-gray-500 archive-count';
                }
            });
        }

        function updateTagStyles() {
            tagButtons.forEach(btn => {
                const tag = btn.getAttribute('data-tag');
                if (tag === currentTag) {
                    btn.className = 'text-xs bg-nikkei-main text-white px-3 py-1.5 rounded-full transition tag-btn shadow-sm ring-2 ring-offset-1 ring-nikkei-main/30';
                } else {
                    btn.className = 'text-xs bg-gray-100 hover:bg-nikkei-light hover:text-nikkei-main px-3 py-1.5 rounded-full transition tag-btn';
                }
            });
        }

        function updateFilterStatus() {
            // アクティブなフィルタがあるかチェック
            const hasActiveFilters = (currentCategory !== 'すべて') || currentYear || currentTag || currentSearchQuery;

            if (hasActiveFilters) {
                filterStatus.classList.remove('hidden');
                activeFiltersList.innerHTML = ''; // クリア

                // カテゴリバッジ
                if (currentCategory !== 'すべて') {
                    const badge = createBadge(`カテゴリ: ${currentCategory}`, clearCategory);
                    activeFiltersList.appendChild(badge);
                }
                // 年バッジ
                if (currentYear) {
                    const badge = createBadge(`年: ${currentYear}`, clearYear);
                    activeFiltersList.appendChild(badge);
                }
                // タグバッジ
                if (currentTag) {
                    const badge = createBadge(`タグ: #${currentTag}`, clearTag);
                    activeFiltersList.appendChild(badge);
                }
                // 検索ワードバッジ (新規追加)
                if (currentSearchQuery) {
                    const badge = createBadge(`検索: "${currentSearchQuery}"`, clearSearch);
                    activeFiltersList.appendChild(badge);
                }
            } else {
                filterStatus.classList.add('hidden');
            }
        }

        function createBadge(text, removeCallback) {
            const span = document.createElement('span');
            span.className = 'inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-white border border-blue-200 text-nikkei-main shadow-sm animate-fadeIn';
            
            const textNode = document.createTextNode(text);
            span.appendChild(textNode);

            const btn = document.createElement('button');
            btn.innerHTML = '<i data-lucide="x" class="w-3 h-3"></i>';
            btn.className = 'hover:bg-blue-100 rounded-full p-0.5 transition-colors';
            btn.onclick = (e) => {
                e.stopPropagation(); // 親への伝播防止
                removeCallback();
            };
            span.appendChild(btn);

            return span;
        }

        // ---------------------------------------------------------
        // データフィルタリング関数（AND条件）
        // ---------------------------------------------------------
        function getFilteredNews() {
            let filtered = newsData;

            // 1. カテゴリで絞り込み
            if (currentCategory !== 'すべて') {
                filtered = filtered.filter(item => item.category === currentCategory);
            }

            // 2. 年で絞り込み (AND)
            if (currentYear) {
                filtered = filtered.filter(item => item.date.startsWith(currentYear));
            }

            // 3. タグで絞り込み (AND)
            if (currentTag) {
                filtered = filtered.filter(item => item.tags && item.tags.includes(currentTag));
            }

            // 4. キーワード検索 (AND) - 新規追加
            if (currentSearchQuery) {
                const lowerQuery = currentSearchQuery.toLowerCase();
                filtered = filtered.filter(item => {
                    // タイトルまたはタグにキーワードが含まれているか
                    const titleMatch = item.title.toLowerCase().includes(lowerQuery);
                    const tagMatch = item.tags && item.tags.some(tag => tag.toLowerCase().includes(lowerQuery));
                    return titleMatch || tagMatch;
                });
            }

            return filtered;
        }

        // ---------------------------------------------------------
        // ページを描画する関数
        // ---------------------------------------------------------
        function renderPage(page) {
            currentPage = page;
            
            // フィルタリングされたデータを取得
            const filteredData = getFilteredNews();

            // コンテナをクリア
            newsContainer.innerHTML = '';

            // 該当するデータがない場合
            if (filteredData.length === 0) {
                newsContainer.innerHTML = `
                    <div class="text-center py-20 fade-in-up">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full mb-4">
                            <i data-lucide="search-x" class="w-8 h-8 text-gray-400"></i>
                        </div>
                        <p class="text-gray-500 font-bold">条件に一致する記事は見つかりませんでした。</p>
                        <p class="text-sm text-gray-400 mt-2">条件を変更して再度お試しください。</p>
                        <button onclick="resetFilters()" class="mt-4 text-sm text-nikkei-main underline hover:no-underline">条件をすべて解除する</button>
                    </div>
                `;
                paginationContainer.innerHTML = ''; 
                lucide.createIcons();
                // アニメーション適用
                setTimeout(() => {
                    const el = newsContainer.querySelector('.fade-in-up');
                    if(el) el.classList.add('visible');
                }, 50);
                return;
            }

            // データの抽出（スライス）
            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageItems = filteredData.slice(start, end);

            // 記事を描画
            pageItems.forEach(item => {
                const colorClass = categoryColors[item.category] || categoryColors['default'];
                
                const html = `
                    <article class="fade-in-up py-5 flex flex-col md:flex-row md:items-center gap-2 md:gap-6 group cursor-pointer" onclick="location.href='${item.url}'">
                        <div class="flex items-center gap-4 min-w-[180px]">
                            <time class="font-mono text-gray-500 text-sm tracking-wide">${item.date}</time>
                            <span class="${colorClass} text-xs font-bold px-2.5 py-1 rounded md:hidden">${item.category}</span>
                        </div>
                        
                        <div class="flex-grow">
                            <div class="mb-1 hidden md:block">
                                    <span class="${colorClass} text-xs font-bold px-2.5 py-1 rounded inline-block mb-2">${item.category}</span>
                            </div>
                            <h3 class="text-base md:text-lg font-bold text-gray-800 group-hover:text-nikkei-main transition-colors leading-snug">
                                ${item.title}
                            </h3>
                            <!-- タグ表示 -->
                            <div class="flex flex-wrap gap-2 mt-2">
                                ${item.tags ? item.tags.map(t => {
                                    // 選択中のタグはハイライト
                                    const isActive = t === currentTag;
                                    const style = isActive ? 'bg-nikkei-main text-white' : 'text-gray-400 bg-gray-50 group-hover:bg-gray-100';
                                    return `<span class="text-[10px] px-2 py-0.5 rounded transition-colors ${style}">#${t}</span>`;
                                }).join('') : ''}
                            </div>
                        </div>
                        
                        <div class="hidden md:flex items-center justify-center w-8 h-8 rounded-full bg-gray-50 text-gray-300 group-hover:bg-nikkei-main group-hover:text-white transition-all transform group-hover:translate-x-1">
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </div>
                    </article>
                `;
                newsContainer.insertAdjacentHTML('beforeend', html);
            });

            // アイコンとアニメーションの再適用
            lucide.createIcons();
            applyAnimations();
            
            // ページネーションボタンの更新
            renderPagination(filteredData.length);
        }

        // ---------------------------------------------------------
        // ページネーションボタンを描画する関数
        // ---------------------------------------------------------
        function renderPagination(totalItems) {
            paginationContainer.innerHTML = '';
            
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            if (totalPages <= 1) return; 

            // 「前へ」ボタン
            const prevBtn = document.createElement('button');
            prevBtn.className = `w-10 h-10 flex items-center justify-center rounded border border-gray-200 transition ${currentPage === 1 ? 'text-gray-300 cursor-not-allowed' : 'hover:bg-gray-50 text-gray-600'}`;
            prevBtn.innerHTML = '<i data-lucide="chevron-left" class="w-4 h-4"></i>';
            prevBtn.onclick = () => { 
                if(currentPage > 1) {
                    renderPage(currentPage - 1);
                    scrollToTop();
                }
            };
            paginationContainer.appendChild(prevBtn);

            // 数字ボタン
            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                if (i === currentPage) {
                    btn.className = 'w-10 h-10 flex items-center justify-center rounded bg-nikkei-main text-white font-bold shadow-sm';
                } else {
                    btn.className = 'w-10 h-10 flex items-center justify-center rounded border border-gray-200 hover:bg-gray-50 text-gray-600 transition';
                    btn.onclick = () => {
                        renderPage(i);
                        scrollToTop();
                    };
                }
                btn.innerText = i;
                paginationContainer.appendChild(btn);
            }

            // 「次へ」ボタン
            const nextBtn = document.createElement('button');
            nextBtn.className = `w-10 h-10 flex items-center justify-center rounded border border-gray-200 transition ${currentPage === totalPages ? 'text-gray-300 cursor-not-allowed' : 'hover:bg-gray-50 text-gray-600'}`;
            nextBtn.innerHTML = '<i data-lucide="chevron-right" class="w-4 h-4"></i>';
            nextBtn.onclick = () => { 
                if(currentPage < totalPages) {
                    renderPage(currentPage + 1);
                    scrollToTop();
                }
            };
            paginationContainer.appendChild(nextBtn);

            lucide.createIcons();
        }

        function scrollToTop() {
            window.scrollTo({
                top: newsContainer.offsetTop - 100,
                behavior: 'smooth'
            });
        }

        // アニメーション適用関数
        function applyAnimations() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('.fade-in-up').forEach(el => observer.observe(el));
        }

        // 初回実行
        window.addEventListener('DOMContentLoaded', () => {
            renderPage(1);
            updateArchiveCounts(); 
        });

    </script>
</body>
</html>